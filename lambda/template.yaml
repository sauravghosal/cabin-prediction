AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: >
  Initial Ingestion

  SAM Template for Code Initial Ingestion

# More info about Globals: https://github.com/awslabs/serverless-application-model/blob/master/docs/globals.rst
Globals:
  Function:
    Timeout: 60

Resources:
  InitialIngestionFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: initial_ingestion/
      Handler: initial.handler
      Runtime: python3.7
      Environment:
        Variables:
          DB_DATABASE: test-db.c41grk8eakd2.us-east-2.rds.amazonaws.com
          DB_USER: admin
          DB_PASSWORD: password
      Role: !GetAtt IngestionFunctionRole.Arn

  IncrementalIngestionFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: incremental_ingestion/
      Handler: incremental.handler
      Runtime: python3.7
      Environment:
        Variables:
          DB_DATABASE: test-db.c41grk8eakd2.us-east-2.rds.amazonaws.com
          DB_USER: admin
          DB_PASSWORD: password
      Role: !GetAtt IngestionFunctionRole.Arn

  IngestionFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaRole
        - arn:aws:iam::582807997595:policy/s3-data-bucket-access
      RoleName: IngestionFunctionRole

Outputs:
  # ServerlessRestApi is an implicit API created out of Events key under Serverless::Function
  # Find out more about other implicit resources you can reference within SAM
  # https://github.com/awslabs/serverless-application-model/blob/master/docs/internals/generated_resources.rst#api
  InitialIngestionFunction:
    Description: "Initial Ingestion Lambda Function ARN"
    Value: !GetAtt InitialIngestionFunction.Arn
  IngestionFunctionRole:
    Description: "IAM Role created for the ingestion functions"
    Value: !GetAtt IngestionFunctionRole.Arn
